<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0d6efd" />
<title>Entrega de Turno – Alcohol</title>
<style>
  :root { --c1:#0d6efd; --c2:#198754; --c3:#dc3545; --c4:#6b7280; --bg:#f4f6fb; --ink:#1f2937; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); margin:0; color:#111827; }
  header { position: sticky; top:0; z-index:5; background:#fff; padding: .9rem 1rem calc(.6rem + env(safe-area-inset-top)); box-shadow: 0 4px 16px rgba(0,0,0,.06); }
  header h1{ margin:0; font-size:1.15rem; }
  header .sub { color:#64748b; font-size:.88rem; margin-top:.25rem; }
  .wrap { padding:1rem; padding-bottom: calc(6.2rem + env(safe-area-inset-bottom)); max-width: 960px; margin: 0 auto; }
  fieldset { border:1px solid #e5e7eb; border-radius:12px; margin: .9rem 0; padding: .9rem; background:#fff; }
  legend { padding:0 .6rem; font-weight:700; color:#111827; }
  .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:.8rem .9rem; }
  .col-12{grid-column: span 12;} .col-8{grid-column: span 8;} .col-6{grid-column: span 6;} .col-4{grid-column:span 4;} .col-3{grid-column:span 3;}
  @media (max-width:760px){ .col-8,.col-6,.col-4,.col-3{grid-column:span 12;} }
  label { display:block; font-size:.96rem; margin-bottom:.25rem; }
  input, select, textarea { width:100%; padding:.82rem .95rem; border:1px solid #d1d5db; border-radius:12px; background:#fff; font-size:1rem; -webkit-tap-highlight-color: transparent; }
  input.readonly, textarea.readonly{ background:#f3f6fb; }
  textarea { min-height:88px; resize: vertical; }
  .hint { font-size:.84rem; color:#6b7280; }
  .muted { color:#6b7280; font-size:.92rem; }
  .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:.7rem .9rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;}
  .kpi .val { font-weight:800; }
  .ok { color: var(--c2); } .warn { color: #f59e0b; } .err { color: var(--c3); }
  .rowline { border-top:1px dashed #e5e7eb; margin:.7rem 0 0; padding-top:.7rem; }
  .actionbar { position: fixed; left:0; right:0; bottom:0; z-index:10; background:#fff; padding: .6rem .8rem calc(.8rem + env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,.08); display:flex; gap:.5rem; flex-wrap:wrap; }
  .actionbar button{ flex:1 1 48%; min-height:46px; border:none; border-radius:12px; color:#fff; font-weight:700; font-size:1rem; letter-spacing:.2px; }
  .primary{ background:var(--c1); } .success{ background:var(--c2);} .ghost{ background:#fff; color:#111; border:1px solid #d1d5db;} .secondary{ background:var(--c4); color:#fff;}
  .badge { display:inline-block; background:#eef2ff; color:#1e3a8a; padding:.1rem .5rem; border-radius:999px; font-size:.78rem; }
  /* Estibas (chips) */
  .chiplist { display:flex; gap:.4rem; flex-wrap: wrap; margin-top:.5rem; }
  .chip { background:#eef2ff; color:#1e3a8a; padding:.28rem .55rem; border-radius:999px; display:inline-flex; align-items:center; gap:.4rem; font-weight:700; }
  .chip button { border:none; background:transparent; color:#1e3a8a; cursor:pointer; font-weight:900; }
  /* Paros (listas verticales) */
  .paro-form { display:flex; gap:.5rem; flex-wrap:wrap; }
  .paro-form input[type="number"]{ max-width: 140px; }
  .paro-list { margin:.5rem 0 0; padding:0; list-style:none; }
  .paro-item { display:flex; align-items:flex-start; gap:.6rem; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; padding:.5rem .6rem; margin-bottom:.5rem; }
  .paro-min { font-weight:800; color:#111827; min-width:60px; }
  .paro-just { color:#374151; white-space: pre-wrap; }
  .paro-actions button { border:none; background:transparent; color:#dc2626; cursor:pointer; font-weight:800; }
  .error-msg { color:#dc2626; font-size:.85rem; margin-top:.25rem; display:none; }
  .show { display:block; }
</style>
</head>
<body>
<header>
  <h1>Entrega de Turno – Alcohol</h1>
  <div class="sub">Calcula teóricas con tu regla, descuenta pausas/casino, valida paros y genera mensaje para WhatsApp.</div>
</header>

<div class="wrap">
  <fieldset>
    <legend>Datos generales</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fecha">Fecha (del turno)</label>
        <input type="date" id="fecha" required />
      </div>
      <div class="col-6">
        <label for="turno">Turno</label>
        <select id="turno" required>
          <option value="">-- Seleccione --</option>
          <option value="1">Turno 1 (07:00–15:00)</option>
          <option value="2">Turno 2 (15:00–23:00)</option>
        </select>
      </div>
      <div class="col-12">
        <label for="ausentismos">Ausentismos</label>
        <input type="text" id="ausentismos" placeholder="Nombres, horas, observaciones..." inputmode="text"/>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Fabricación</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fab_lote">Lote</label>
        <input type="text" id="fab_lote" placeholder="Ej: AL-240215-01" />
      </div>
      <div class="col-6">
        <label for="fab_estado">Estado</label>
        <select id="fab_estado">
          <option value="N/A">N/A</option>
          <option value="En proceso">En proceso</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Finalizado">Finalizado</option>
        </select>
      </div>
      <div class="col-12">
        <label for="fab_pendientes">Pendientes</label>
        <textarea id="fab_pendientes" placeholder="Acciones abiertas, materiales, calidad, etc."></textarea>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Envase</legend>
    <div class="grid">
      <div class="col-12">
        <label for="env_producto">Producto</label>
        <select id="env_producto" required>
          <option value="">-- Seleccione --</option>
          <option>ALCOHOL 700ML</option>
          <option>ALCOHOL 350 ML</option>
          <option>ALCOHOL 120ML</option>
          <option>ALCOHOL GARRAFA 37000 ML</option>
          <option>MERTHIOLATE ROJO</option>
          <option>MERTHIOLATE INCOLORO</option>
          <option>ILOTICINA PLUS</option>
          <option>ILOTICINA DUO</option>
          <option>ILOTICINA PLUS MM</option>
          <option>ILOTICINA DUO MM</option>
        </select>
        <div id="prod_err" class="error-msg">Seleccione un producto para calcular la velocidad programada.</div>
      </div>
      <div class="col-6">
        <label for="env_lote">Lote</label>
        <input type="text" id="env_lote" placeholder="Ej: ENV-240215-03" />
      </div>
      <div class="col-6">
        <div class="muted">Cálculo fijo: <span class="badge">Inicio lote → Fin turno</span> o <span class="badge">Inicio turno → Fin lote</span> si inició día anterior.</div>
      </div>

      <div class="col-6">
        <label for="env_inicio">Inicio del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_inicio" required />
      </div>
      <div class="col-6">
        <label for="env_fin">Fin del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_fin" />
        <div class="hint">Si el lote inició un día anterior, se usa este fin (si existe).</div>
      </div>

      <div class="col-6">
        <label for="vel_prog">Velocidad programada (frascos/min)</label>
        <input type="number" id="vel_prog" class="readonly" readonly />
        <div class="hint">Se autocompleta según el producto.</div>
      </div>
      <div class="col-6">
        <label for="vel_real">Velocidad real (frascos/min)</label>
        <input type="number" id="vel_real" min="0" step="0.1" placeholder="Dato reportado por el supervisor" />
      </div>

      <div class="col-6">
        <label for="unid_teoricas">Unidades teóricas (auto)</label>
        <input type="number" id="unid_teoricas" class="readonly" readonly />
        <div class="muted" id="detalle_descuentos"></div>
      </div>
      <div class="col-6">
        <label for="unid_reales">Unidades reales</label>
        <input type="number" id="unid_reales" min="0" />
      </div>

      <!-- ESTIBAS 000–999 -->
      <div class="col-12">
        <label>Estibas (códigos 000–999)</label>
        <div class="paro-form">
          <input id="estiba_code" type="text" inputmode="numeric" pattern="\\d{3}" maxlength="3" placeholder="Ej: 007" />
          <button id="btn_add_estiba" class="ghost" type="button">Agregar</button>
          <div class="muted">Total: <span id="estibas_count">0</span></div>
        </div>
        <div id="estiba_err" class="error-msg">Usa 3 dígitos (000–999). Evita duplicados.</div>
        <div class="chiplist" id="estibas_chiplist"></div>
      </div>

      <div class="col-12">
        <label for="horas_atraso">Horas de atraso (auto)</label>
        <input type="text" id="horas_atraso" class="readonly" readonly />
        <div class="muted" id="atraso_min_detalle"></div>
      </div>
    </div>

    <div class="rowline"></div>

    <!-- PAROS POR CATEGORÍA: listas verticales con (min + justificación) -->
    <div class="grid">
      <div class="col-12"><b>Paros</b> (agrega los ítems por categoría)</div>

      <!-- Generador de bloques de paros (sección repetida por categoría) -->
      <div class="col-12">
        <label>Equipo · <span class="badge">Total: <span id="sum_equipo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="equipo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="equipo_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="equipo">Agregar</button>
        </div>
        <div id="equipo_err" class="error-msg">Ingrese minutos (>0). Justificación opcional.</div>
        <ul class="paro-list" id="list_equipo"></ul>
      </div>

      <div class="col-12">
        <label>Proceso · <span class="badge">Total: <span id="sum_proceso">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="proceso_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="proceso_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="proceso">Agregar</button>
        </div>
        <div id="proceso_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_proceso"></ul>
      </div>

      <div class="col-12">
        <label>Alistamiento · <span class="badge">Total: <span id="sum_alistamiento">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="alistamiento_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="alistamiento_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="alistamiento">Agregar</button>
        </div>
        <div id="alistamiento_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_alistamiento"></ul>
      </div>

      <div class="col-12">
        <label>Ausentismo · <span class="badge">Total: <span id="sum_ausentismo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="ausentismo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="ausentismo_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="ausentismo">Agregar</button>
        </div>
        <div id="ausentismo_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_ausentismo"></ul>
      </div>

      <div class="col-12">
        <label>Novedad estéril · <span class="badge">Total: <span id="sum_esteril">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="esteril_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="esteril_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="esteril">Agregar</button>
        </div>
        <div id="esteril_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_esteril"></ul>
      </div>

      <div class="col-12">
        <label>Materiales · <span class="badge">Total: <span id="sum_materiales">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="materiales_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="materiales_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="materiales">Agregar</button>
        </div>
        <div id="materiales_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_materiales"></ul>
      </div>

      <div class="col-12 kpi">
        <div><b>Total paros</b> (min): <span class="val" id="paros_total">0</span></div>
        <div id="paros_alerta" class="muted">Se validará contra el atraso calculado.</div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Mensaje</legend>
    <div class="grid">
      <div class="col-12">
        <label for="mensaje">Texto generado (WhatsApp)</label>
        <textarea id="mensaje" class="readonly" readonly placeholder="Toca Generar para ver el mensaje…"></textarea>
      </div>
    </div>
  </fieldset>
</div>

<div class="actionbar">
  <button class="primary" id="btn_generar">Generar</button>
  <button class="success" id="btn_whatsapp" disabled>WhatsApp</button>
  <button class="ghost" id="btn_copiar" disabled>Copiar</button>
  <button class="secondary" id="btn_limpiar">Limpiar</button>
</div>

<script>
(function(){
  // Velocidades programadas
  const speedMap = {
    "ALCOHOL 700ML": 54,
    "ALCOHOL 350 ML": 64,
    "ALCOHOL 120ML": 67,
    "ALCOHOL GARRAFA 37000 ML": 6,
    "MERTHIOLATE ROJO": 12,
    "MERTHIOLATE INCOLORO": 12,
    "ILOTICINA PLUS": 10,
    "ILOTICINA DUO": 10,
    "ILOTICINA PLUS MM": 10,
    "ILOTICINA DUO MM": 10
  };

  // DOM
  const fecha = document.getElementById('fecha');
  const turno = document.getElementById('turno');
  const ausentismos = document.getElementById('ausentismos');
  const fab_lote = document.getElementById('fab_lote');
  const fab_estado = document.getElementById('fab_estado');
  const fab_pendientes = document.getElementById('fab_pendientes');
  const env_producto = document.getElementById('env_producto');
  const prod_err = document.getElementById('prod_err');
  const env_lote = document.getElementById('env_lote');
  const env_inicio = document.getElementById('env_inicio');
  const env_fin = document.getElementById('env_fin');
  const vel_prog = document.getElementById('vel_prog');
  const vel_real = document.getElementById('vel_real');
  const unid_teoricas = document.getElementById('unid_teoricas');
  const unid_reales = document.getElementById('unid_reales');
  const horas_atraso = document.getElementById('horas_atraso');
  const atraso_min_detalle = document.getElementById('atraso_min_detalle');
  const detalle_descuentos = document.getElementById('detalle_descuentos');

  // Estibas
  const estiba_code = document.getElementById('estiba_code');
  const btn_add_estiba = document.getElementById('btn_add_estiba');
  const estiba_err = document.getElementById('estiba_err');
  const estibas_chiplist = document.getElementById('estibas_chiplist');
  const estibas_count = document.getElementById('estibas_count');

  // Paros
  const paros_alerta = document.getElementById('paros_alerta');
  const paros_total = document.getElementById('paros_total');

  const sums = {
    equipo: document.getElementById('sum_equipo'),
    proceso: document.getElementById('sum_proceso'),
    alistamiento: document.getElementById('sum_alistamiento'),
    ausentismo: document.getElementById('sum_ausentismo'),
    esteril: document.getElementById('sum_esteril'),
    materiales: document.getElementById('sum_materiales'),
  };

  const addInputs = {
    equipo: { min: document.getElementById('equipo_min'), just: document.getElementById('equipo_just'), list: document.getElementById('list_equipo'), err: document.getElementById('equipo_err') },
    proceso:{ min: document.getElementById('proceso_min'), just: document.getElementById('proceso_just'), list: document.getElementById('list_proceso'), err: document.getElementById('proceso_err') },
    alistamiento:{ min: document.getElementById('alistamiento_min'), just: document.getElementById('alistamiento_just'), list: document.getElementById('list_alistamiento'), err: document.getElementById('alistamiento_err') },
    ausentismo:{ min: document.getElementById('ausentismo_min'), just: document.getElementById('ausentismo_just'), list: document.getElementById('list_ausentismo'), err: document.getElementById('ausentismo_err') },
    esteril:{ min: document.getElementById('esteril_min'), just: document.getElementById('esteril_just'), list: document.getElementById('list_esteril'), err: document.getElementById('esteril_err') },
    materiales:{ min: document.getElementById('materiales_min'), just: document.getElementById('materiales_just'), list: document.getElementById('list_materiales'), err: document.getElementById('materiales_err') },
  };

  const btn_generar = document.getElementById('btn_generar');
  const btn_whatsapp = document.getElementById('btn_whatsapp');
  const btn_copiar = document.getElementById('btn_copiar');
  const btn_limpiar = document.getElementById('btn_limpiar');
  const mensaje = document.getElementById('mensaje');

  // Estado
  let estibasArr = []; // ["007","145",...]
  const parosData = { equipo:[], proceso:[], alistamiento:[], ausentismo:[], esteril:[], materiales:[] };

  // Utils
  fecha.valueAsDate = new Date();
  fab_estado.value = "N/A";

  function parseDTLocal(v){ if(!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d; }
  function two(n){ return String(n).padStart(2,'0'); }
  function fmtDateTime(d){ if(!d) return ""; return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`; }
  function minutesBetween(a,b){ return (b - a) / 60000; }

  function getShiftBounds(dateOnly, turnoVal){
    if(!dateOnly || !turnoVal) return null;
    const base = new Date(dateOnly);
    const start = new Date(base), end = new Date(base);
    if(turnoVal==='1'){ start.setHours(7,0,0,0); end.setHours(15,0,0,0); }
    else if(turnoVal==='2'){ start.setHours(15,0,0,0); end.setHours(23,0,0,0); }
    else return null;
    return {start, end};
  }

  function sameDay(d1, d2){ return d1 && d2 && d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate(); }

  // Casino: 12:00 (T1) y 19:00 (T2) si la ventana lo cruza (40 min)
  function casinoMinutes(bounds, winStart, winEnd, turnoVal){
    let m = 0;
    if(turnoVal === '1'){
      const t1200 = new Date(bounds.start); t1200.setHours(12,0,0,0);
      if(winStart < t1200 && winEnd > t1200) m += 40;
    } else if (turnoVal === '2'){
      const t1900 = new Date(bounds.start); t1900.setHours(19,0,0,0);
      if(winStart < t1900 && winEnd > t1900) m += 40;
    }
    return m;
  }

  // Pausas activas: 10 min cada 120 min de trabajo efectivo (iterativo)
  function computeWorkAndBreaks(minutesBase){
    let work = Math.max(minutesBase, 0);
    let prev = -1, count = 0, it = 0;
    while (it < 10){
      count = Math.floor(work / 120);
      if(count === prev) break;
      prev = count;
      work = Math.max(minutesBase - count*10, 0);
      it++;
    }
    return { work, breaks: count*10, count };
  }

  function updateVelocidadProgramada(){
    const prod = env_producto.value;
    vel_prog.value = prod && speedMap[prod] ? speedMap[prod] : "";
    prod_err.classList.toggle('show', !vel_prog.value);
  }

  function updateCalculos(){
    updateVelocidadProgramada();

    const turnoVal = turno.value;
    const fechaVal = fecha.value ? new Date(fecha.value) : null;
    const bounds = getShiftBounds(fechaVal, turnoVal);

    const inicio = parseDTLocal(env_inicio.value);
    const fin = parseDTLocal(env_fin.value);
    const velProg = Number(vel_prog.value || 0);
    const reales = Number(unid_reales.value || 0);

    // Reset vistas
    unid_teoricas.value = "";
    horas_atraso.value = "";
    atraso_min_detalle.textContent = "";
    delete atraso_min_detalle.dataset.minutos;
    detalle_descuentos.textContent = "";

    // Requisitos mínimos
    if(!bounds || !inicio || !velProg){
      validateParosVsAtraso();
      return;
    }

    // Regla de cálculo:
    // - Mismo día: Inicio del lote → Fin del turno
    // - Si inició día anterior: Inicio del turno → Fin del lote (si hay fin; si no, hasta fin del turno)
    let winStart, winEnd;
    const inicioEsPrevio = inicio < bounds.start && !sameDay(inicio, bounds.start);
    if (inicioEsPrevio){
      winStart = bounds.start;
      winEnd = fin ? new Date(Math.min(fin.getTime(), bounds.end.getTime())) : bounds.end;
    } else {
      winStart = new Date(Math.max(inicio.getTime(), bounds.start.getTime()));
      winEnd = bounds.end;
    }

    if(!(winStart < winEnd)){
      unid_teoricas.value = 0;
      horas_atraso.value = (0).toFixed(2);
      atraso_min_detalle.dataset.minutos = 0;
      validateParosVsAtraso();
      return;
    }

    // Minutos brutos y descuentos
    const minutosBrutos = Math.max(0, minutesBetween(winStart, winEnd));
    const descCasino = casinoMinutes(bounds, winStart, winEnd, turnoVal);
    const minutosBase = Math.max(minutosBrutos - descCasino, 0);
    const { work: minutosTrabajo, breaks: descPausas, count: cantPausas } = computeWorkAndBreaks(minutosBase);
    const minutosEfectivos = Math.max(minutosTrabajo, 0);

    // Teóricas
    const teoricas = Math.floor(minutosEfectivos * velProg);
    unid_teoricas.value = isFinite(teoricas) ? teoricas : "";

    // Detalle
    const casinoTxt = descCasino ? ` · Casino ${descCasino} min` : '';
    const pausasTxt = cantPausas > 0 ? ` · Pausas ${cantPausas}×10 = ${descPausas} min` : ' · Pausas 0 min';
    detalle_descuentos.textContent = `Ventana: ${fmtDateTime(winStart)} → ${fmtDateTime(winEnd)} | Bruto: ${Math.round(minutosBrutos)} min${casinoTxt}${pausasTxt} → Efectivo: ${Math.round(minutosEfectivos)} min`;

    // Atraso
    if(isFinite(reales) && velProg>0){
      const diffUnid = Math.max(teoricas - reales, 0);
      const atrasoMin = (diffUnid / velProg) * 60;
      horas_atraso.value = (atrasoMin/60).toFixed(2);
      atraso_min_detalle.textContent = `≈ ${Math.round(atrasoMin)} min de atraso`;
      atraso_min_detalle.dataset.minutos = Math.round(atrasoMin);
    }

    validateParosVsAtraso();
  }

  // ------------ Estibas (chips 000–999) -------------
  function stripNonDigits(s){ return (s||'').replace(/\D+/g,''); }
  function addEstiba(){
    estiba_err.classList.remove('show');
    let code = stripNonDigits(estiba_code.value);
    if(code.length === 0){ estiba_err.textContent = 'Ingrese un código de 3 dígitos (000–999).'; estiba_err.classList.add('show'); return; }
    if(code.length < 3) code = code.padStart(3, '0');
    if(!/^\d{3}$/.test(code)){ estiba_err.textContent = 'Formato inválido. Use 3 dígitos, ej: 007.'; estiba_err.classList.add('show'); return; }
    if(estibasArr.includes(code)){ estiba_err.textContent = 'Ese código ya fue agregado.'; estiba_err.classList.add('show'); return; }
    estibasArr.push(code);
    estiba_code.value = '';
    renderEstibas();
  }
  function renderEstibas(){
    estibas_chiplist.innerHTML = '';
    estibasArr.forEach((c, idx)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';

