<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0d6efd" />
<title>Entrega de Turno – Alcohol</title>
<style>
  :root { --c1:#0d6efd; --c2:#198754; --c3:#dc3545; --c4:#6b7280; --bg:#f4f6fb; --ink:#1f2937; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); margin:0; color:#111827; }
  header { position: sticky; top:0; z-index:5; background:#fff; padding: .9rem 1rem calc(.6rem + env(safe-area-inset-top)); box-shadow: 0 4px 16px rgba(0,0,0,.06); }
  header h1{ margin:0; font-size:1.15rem; }
  header .sub { color:#64748b; font-size:.88rem; margin-top:.25rem; }
  .wrap { padding:1rem; padding-bottom: calc(6.2rem + env(safe-area-inset-bottom)); max-width: 960px; margin: 0 auto; }
  fieldset { border:1px solid #e5e7eb; border-radius:12px; margin: .9rem 0; padding: .9rem; background:#fff; }
  legend { padding:0 .6rem; font-weight:700; color:#111827; }
  .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:.8rem .9rem; }
  .col-12{grid-column: span 12;} .col-8{grid-column: span 8;} .col-6{grid-column: span 6;} .col-4{grid-column:span 4;} .col-3{grid-column:span 3;}
  @media (max-width:760px){ .col-8,.col-6,.col-4,.col-3{grid-column:span 12;} }
  label { display:block; font-size:.96rem; margin-bottom:.25rem; }
  input, select, textarea { width:100%; padding:.82rem .95rem; border:1px solid #d1d5db; border-radius:12px; background:#fff; font-size:1rem; -webkit-tap-highlight-color: transparent; }
  input.readonly, textarea.readonly{ background:#f3f6fb; }
  textarea { min-height:88px; resize: vertical; }
  .hint { font-size:.84rem; color:#6b7280; }
  .muted { color:#6b7280; font-size:.92rem; }
  .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:.7rem .9rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;}
  .kpi .val { font-weight:800; }
  .ok { color: var(--c2); } .warn { color: #f59e0b; } .err { color: var(--c3); }
  .rowline { border-top:1px dashed #e5e7eb; margin:.7rem 0 0; padding-top:.7rem; }
  .actionbar { position: fixed; left:0; right:0; bottom:0; z-index:10; background:#fff; padding: .6rem .8rem calc(.8rem + env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,.08); display:flex; gap:.5rem; flex-wrap:wrap; }
  .actionbar button{ flex:1 1 48%; min-height:46px; border:none; border-radius:12px; color:#fff; font-weight:700; font-size:1rem; letter-spacing:.2px; }
  .primary{ background:var(--c1); } .success{ background:var(--c2);} .ghost{ background:#fff; color:#111; border:1px solid #d1d5db;} .secondary{ background:var(--c4); color:#fff;}
  .badge { display:inline-block; background:#eef2ff; color:#1e3a8a; padding:.1rem .5rem; border-radius:999px; font-size:.78rem; }
  .paro-form { display:flex; gap:.5rem; flex-wrap:wrap; }
  .paro-form input[type="number"]{ max-width: 140px; }
  .paro-list { margin:.5rem 0 0; padding:0; list-style:none; }
  .paro-item { display:flex; align-items:flex-start; gap:.6rem; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; padding:.5rem .6rem; margin-bottom:.5rem; }
  .paro-min { font-weight:800; color:#111827; min-width:60px; }
  .paro-just { color:#374151; white-space: pre-wrap; }
  .paro-actions button { border:none; background:transparent; color:#dc2626; cursor:pointer; font-weight:800; }
  .error-msg { color:#dc2626; font-size:.85rem; margin-top:.25rem; display:none; }
  .show { display:block; }
</style>
</head>
<body>
<header>
  <h1>Entrega de Turno – Alcohol</h1>
  <div class="sub">Cálculo de teóricas (intersección Turno ∩ Lote), pausas/casino, productividad, paros y WhatsApp.</div>
</header>

<div class="wrap">
  <fieldset>
    <legend>Datos generales</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fecha">Fecha (del turno)</label>
        <input type="date" id="fecha" required />
      </div>
      <div class="col-6">
        <label for="turno">Turno</label>
        <!-- 4 variantes con dataset para horas e info del turno -->
        <select id="turno" required>
          <option value="">-- Seleccione --</option>
          <option value="1_0700_1500" data-turno="1" data-start="07:00" data-end="15:00" data-cross="same">Turno 1 (07:00–15:00)</option>
          <option value="1_0700_1630" data-turno="1" data-start="07:00" data-end="16:30" data-cross="same">Turno 1 (07:00–16:30)</option>
          <option value="2_1500_2300" data-turno="2" data-start="15:00" data-end="23:00" data-cross="same">Turno 2 (15:00–23:00)</option>
          <option value="2_1500_0145" data-turno="2" data-start="15:00" data-end="01:45" data-cross="next">Turno 2 (15:00–01:45)</option>
        </select>
      </div>
      <div class="col-12">
        <label for="ausentismos">Ausentismos</label>
        <input type="text" id="ausentismos" placeholder="Nombres, horas, observaciones..." inputmode="text"/>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Fabricación</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fab_lote">Lote</label>
        <input type="text" id="fab_lote" placeholder="Ej: 6A001" />
      </div>
      <div class="col-6">
        <label for="fab_estado">Estado</label>
        <select id="fab_estado">
          <option value="N/A">N/A</option>
          <option value="En proceso">En proceso</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Finalizado">Finalizado</option>
        </select>
      </div>
      <div class="col-12">
        <label for="fab_pendientes">Pendientes</label>
        <textarea id="fab_pendientes" placeholder="Acciones abiertas, materiales, calidad, etc."></textarea>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Envase</legend>
    <div class="grid">
      <div class="col-12">
        <label for="env_producto">Producto</label>
        <!-- Opciones con data-speed para autollenar -->
        <select id="env_producto" required>
          <option value="">-- Seleccione --</option>
          <option value="ALCOHOL 700ML" data-speed="54">ALCOHOL 700ML</option>
          <option value="ALCOHOL 350 ML" data-speed="64">ALCOHOL 350 ML</option>
          <option value="ALCOHOL 120ML" data-speed="67">ALCOHOL 120ML</option>
          <option value="ALCOHOL GARRAFA 37000 ML" data-speed="6">ALCOHOL GARRAFA 37000 ML</option>
          <option value="MERTHIOLATE ROJO" data-speed="12">MERTHIOLATE ROJO</option>
          <option value="MERTHIOLATE INCOLORO" data-speed="12">MERTHIOLATE INCOLORO</option>
          <option value="ILOTICINA PLUS" data-speed="10">ILOTICINA PLUS</option>
          <option value="ILOTICINA DUO" data-speed="10">ILOTICINA DUO</option>
          <option value="ILOTICINA PLUS MM" data-speed="10">ILOTICINA PLUS MM</option>
          <option value="ILOTICINA DUO MM" data-speed="10">ILOTICINA DUO MM</option>
        </select>
        <div id="prod_err" class="error-msg">Seleccione un producto válido para asignar la velocidad programada.</div>
      </div>

      <div class="col-6">
        <label for="env_lote">Lote</label>
        <input type="text" id="env_lote" placeholder="Ej: 6A001" />
      </div>
      <div class="col-6">
        <div class="muted">Cálculo: intersección entre el turno seleccionado y la actividad real del lote.</div>
      </div>

      <div class="col-6">
        <label for="env_inicio">Inicio del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_inicio" required />
      </div>
      <div class="col-6">
        <label for="env_fin">Fin del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_fin" />
        <div class="hint">Si no terminó, déjelo vacío.</div>
      </div>

      <div class="col-6">
        <label for="vel_prog">Velocidad programada (frascos/min)</label>
        <input type="number" id="vel_prog" class="readonly" readonly />
        <div class="hint">Se autocompleta según el producto.</div>
      </div>
      <div class="col-6">
        <label for="vel_real">Velocidad real (frascos/min)</label>
        <input type="number" id="vel_real" min="0" step="0.1" placeholder="Dato reportado por el supervisor" />
      </div>

      <div class="col-6">
        <label for="unid_teoricas">Unidades teóricas (auto)</label>
        <input type="number" id="unid_teoricas" class="readonly" readonly />
        <div class="muted" id="detalle_descuentos"></div>
        <div class="error-msg" id="calc_err"></div>
      </div>
      <div class="col-6">
        <label for="unid_reales">Unidades reales</label>
        <input type="number" id="unid_reales" min="0" />
      </div>

      <!-- PRODUCTIVIDAD -->
      <div class="col-12">
        <label for="productividad">Productividad (Unidades reales / Unidades teóricas)</label>
        <input type="text" id="productividad" class="readonly" readonly placeholder="0.00 %" />
        <div class="hint">Se calcula automáticamente al ingresar Unidades reales y al actualizar las teóricas.</div>
      </div>

      <!-- ESTIBAS (campo de texto abierto) -->
      <div class="col-12">
        <label for="estibas_text">Estibas</label>
        <textarea id="estibas_text" placeholder="Ej: Estibas 6A001 área fría · 3 estibas completas..." ></textarea>
      </div>

      <div class="col-12">
        <label for="horas_atraso">Horas de atraso (auto)</label>
        <input type="text" id="horas_atraso" class="readonly" readonly />
        <div class="muted" id="atraso_min_detalle"></div>
      </div>
    </div>

    <div class="rowline"></div>

    <!-- PAROS: listas verticales con (min + justificación) -->
    <div class="grid">
      <div class="col-12"><b>Paros</b> (agrega los ítems por categoría)</div>

      <div class="col-12">
        <label>Equipo · <span class="badge">Total: <span id="sum_equipo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="equipo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="equipo_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="equipo">Agregar</button>
        </div>
        <div id="equipo_err" class="error-msg">Ingrese minutos (>0). Justificación opcional.</div>
        <ul class="paro-list" id="list_equipo"></ul>
      </div>

      <div class="col-12">
        <label>Proceso · <span class="badge">Total: <span id="sum_proceso">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="proceso_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="proceso_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="proceso">Agregar</button>
        </div>
        <div id="proceso_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_proceso"></ul>
      </div>

      <div class="col-12">
        <label>Alistamiento · <span class="badge">Total: <span id="sum_alistamiento">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="alistamiento_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="alistamiento_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="alistamiento">Agregar</button>
        </div>
        <div id="alistamiento_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_alistamiento"></ul>
      </div>

      <div class="col-12">
        <label>Ausentismo · <span class="badge">Total: <span id="sum_ausentismo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="ausentismo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="ausentismo_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="ausentismo">Agregar</button>
        </div>
        <div id="ausentismo_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_ausentismo"></ul>
      </div>

      <div class="col-12">
        <label>Novedad estéril · <span class="badge">Total: <span id="sum_esteril">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="esteril_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="esteril_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="esteril">Agregar</button>
        </div>
        <div id="esteril_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_esteril"></ul>
      </div>

      <div class="col-12">
        <label>Materiales · <span class="badge">Total: <span id="sum_materiales">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="materiales_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="materiales_just" placeholder="Justificación..." />
          <button class="ghost" type="button" data-add="materiales">Agregar</button>
        </div>
        <div id="materiales_err" class="error-msg">Ingrese minutos (>0).</div>
        <ul class="paro-list" id="list_materiales"></ul>
      </div>

      <div class="col-12 kpi">
        <div><b>Total paros</b> (min): <span class="val" id="paros_total">0</span></div>
        <div id="paros_alerta" class="muted">Se validará contra el atraso calculado.</div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Mensaje</legend>
    <div class="grid">
      <div class="col-12">
        <label for="mensaje">Texto generado (WhatsApp)</label>
        <textarea id="mensaje" class="readonly" readonly placeholder="Toca Generar para ver el mensaje…"></textarea>
      </div>
    </div>
  </fieldset>
</div>

<div class="actionbar">
  <button class="primary" id="btn_generar">Generar</button>
  <button class="success" id="btn_whatsapp" disabled>WhatsApp</button>
  <button class="ghost" id="btn_copiar" disabled>Copiar</button>
  <button class="secondary" id="btn_limpiar">Limpiar</button>
</div>

<script>
(function(){
  // -------- Fechas (LOCAL, sin UTC) --------
  function parseDateOnlyLocal(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,(m||1)-1,(d||1),0,0,0,0); }
  function parseDateTimeLocal(s){ if(!s) return null; const [date,time='00:00']=s.split('T'); const [y,m,d]=date.split('-').map(Number); const [hh,mm]=time.split(':').map(Number); return new Date(y,(m||1)-1,(d||1),(hh||0),(mm||0),0,0); }
  function two(n){ return String(n).padStart(2,'0'); }
  function fmtDateTime(d){ if(!d) return ''; return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`; }
  function minutesBetween(a,b){ return (b-a)/60000; }

  // -------- Límites del turno a partir del select (4 variantes, con cruce de medianoche) --------
  const fecha = document.getElementById('fecha');
  const turnoSel = document.getElementById('turno');

  function getShiftBoundsLocal(dateStr){
    if(!dateStr || !turnoSel || !turnoSel.value) return null;
    const opt = turnoSel.selectedOptions && turnoSel.selectedOptions[0];
    if(!opt) return null;
    const base = parseDateOnlyLocal(dateStr);
    const startHM = (opt.dataset.start || '07:00').split(':').map(Number);
    const endHM   = (opt.dataset.end   || '15:00').split(':').map(Number);
    const cross   = (opt.dataset.cross || 'same'); // 'same' | 'next'
    const start = new Date(base); start.setHours(startHM[0]||0, startHM[1]||0, 0, 0);
    const end = new Date(base);   end.setHours(endHM[0]||0,   endHM[1]||0,   0, 0);

    // Si es cruce de medianoche o el fin queda antes/igual al inicio, pasa al día siguiente
    if(cross==='next' || end <= start){
      end.setDate(end.getDate()+1);
    }
    const turnoNum = opt.dataset.turno || '';
    const label = opt.textContent || '';
    return { start, end, turnoNum, label };
  }

  // -------- Descansos --------
  function casinoMinutes(bounds, winStart, winEnd, turnoNum){
    // T1: 12:00 (día base), T2: 19:00 (día base)
    let m=0;
    if(String(turnoNum)==='1'){
      const t=new Date(bounds.start); t.setHours(12,0,0,0);
      if(winStart<t && winEnd>t) m+=40;
    } else if (String(turnoNum)==='2'){
      const t=new Date(bounds.start); t.setHours(19,0,0,0);
      if(winStart<t && winEnd>t) m+=40;
    }
    return m;
  }
  function computeWorkAndBreaks(minutesBase){
    // 10 min cada 120 min de TRABAJO EFECTIVO (iterativo)
    let work=Math.max(minutesBase,0), prev=-1, count=0, it=0;
    while(it<12){
      count=Math.floor(work/120);
      if(count===prev) break;
      prev=count;
      work=Math.max(minutesBase - count*10, 0);
      it++;
    }
    return { work, breaks: count*10, count };
  }

  // -------- DOM refs --------
  const ausentismos = document.getElementById('ausentismos');
  const fab_lote = document.getElementById('fab_lote');
  const fab_estado = document.getElementById('fab_estado');
  const fab_pendientes = document.getElementById('fab_pendientes');

  const env_producto = document.getElementById('env_producto');
  const prod_err = document.getElementById('prod_err');
  const env_lote = document.getElementById('env_lote');
  const env_inicio = document.getElementById('env_inicio');
  const env_fin = document.getElementById('env_fin');
  const vel_prog = document.getElementById('vel_prog');
  const vel_real = document.getElementById('vel_real');
  const unid_teoricas = document.getElementById('unid_teoricas');
  const unid_reales = document.getElementById('unid_reales');
  const productividad = document.getElementById('productividad');
  const estibas_text = document.getElementById('estibas_text');

  const horas_atraso = document.getElementById('horas_atraso');
  const atraso_min_detalle = document.getElementById('atraso_min_detalle');
  const detalle_descuentos = document.getElementById('detalle_descuentos');
  const calc_err = document.getElementById('calc_err');

  // Paros
  const paros_alerta = document.getElementById('paros_alerta');
  const paros_total = document.getElementById('paros_total');
  const sums = {
    equipo: document.getElementById('sum_equipo'),
    proceso: document.getElementById('sum_proceso'),
    alistamiento: document.getElementById('sum_alistamiento'),
    ausentismo: document.getElementById('sum_ausentismo'),
    esteril: document.getElementById('sum_esteril'),
    materiales: document.getElementById('sum_materiales'),
  };
  const addInputs = {
    equipo: { min: document.getElementById('equipo_min'), just: document.getElementById('equipo_just'), list: document.getElementById('list_equipo'), err: document.getElementById('equipo_err') },
    proceso:{ min: document.getElementById('proceso_min'), just: document.getElementById('proceso_just'), list: document.getElementById('list_proceso'), err: document.getElementById('proceso_err') },
    alistamiento:{ min: document.getElementById('alistamiento_min'), just: document.getElementById('alistamiento_just'), list: document.getElementById('list_alistamiento'), err: document.getElementById('alistamiento_err') },
    ausentismo:{ min: document.getElementById('ausentismo_min'), just: document.getElementById('ausentismo_just'), list: document.getElementById('list_ausentismo'), err: document.getElementById('ausentismo_err') },
    esteril:{ min: document.getElementById('esteril_min'), just: document.getElementById('esteril_just'), list: document.getElementById('list_esteril'), err: document.getElementById('esteril_err') },
    materiales:{ min: document.getElementById('materiales_min'), just: document.getElementById('materiales_just'), list: document.getElementById('list_materiales'), err: document.getElementById('materiales_err') },
  };

  // Botones
  const btn_generar = document.getElementById('btn_generar');
  const btn_whatsapp = document.getElementById('btn_whatsapp');
  const btn_copiar = document.getElementById('btn_copiar');
  const btn_limpiar = document.getElementById('btn_limpiar');
  const mensaje = document.getElementById('mensaje');

  // -------- Velocidad programada (lee data-speed del option) --------
  function getSelectedSpeed(){
    const opt = env_producto.selectedOptions && env_producto.selectedOptions[0];
    const ds = opt ? Number(opt.dataset.speed || '') : NaN;
    return isFinite(ds) && ds > 0 ? ds : NaN;
  }
  function updateVelocidadProgramada(){
    const v = getSelectedSpeed();
    if (isFinite(v)) {
      vel_prog.value = v;
      prod_err.classList.remove('show');
    } else {
      vel_prog.value = '';
      prod_err.classList.add('show');
    }
  }

  // -------- Productividad --------
  function updateProductividad(){
    const ut = Number(unid_teoricas?.value || 0);
    const ur = Number(unid_reales?.value || 0);
    if (isFinite(ut) && ut > 0 && isFinite(ur) && ur >= 0){
      const p = (ur / ut) * 100;
      productividad.value = `${p.toFixed(2)} %`;
    } else {
      productividad.value = '';
    }
  }

  // -------- Paros (datos, render y validación) --------
  const parosData = { equipo:[], proceso:[], alistamiento:[], ausentismo:[], esteril:[], materiales:[] };

  function updateParosTotals(){
    const sumCat = arr=>arr.reduce((a,b)=>a+(Number(b.min)||0),0);
    let total=0;
    for(const k of Object.keys(parosData)){ const s=sumCat(parosData[k]); sums[k].textContent=s; total+=s; }
    paros_total.textContent=total;
    validateParosVsAtraso();
  }
  function renderParoList(cat){
    const { list } = addInputs[cat];
    list.innerHTML='';
    parosData[cat].forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='paro-item';
      const safeJust = it.just ? it.just.replace(/</g,'&lt;') : 'Sin justificación';
      // Sin espacios alrededor de la raya "–"
      li.innerHTML = `
        <div class="paro-min">${it.min} min</div>
        <div class="paro-just">${safeJust}</div>
        <div class="paro-actions" style="margin-left:auto;"><button data-del="${cat}:${idx}">✖</button></div>
      `;
      list.appendChild(li);
    });
    updateParosTotals();
  }
  function attachParoHandlers(){
    document.querySelectorAll('button[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const cat = btn.getAttribute('data-add');
        const refs = addInputs[cat];
        refs.err.classList.remove('show');
        const min = Number(refs.min.value);
        const just = String(refs.just.value||'').trim();
        if(!isFinite(min) || min<=0){ refs.err.classList.add('show'); return; }
        parosData[cat].push({min:Math.round(min), just});
        refs.min.value=''; refs.just.value='';
        renderParoList(cat);
      });
    });
    document.addEventListener('click',(e)=>{
      const t=e.target;
      if(t && t.matches('button[data-del]')){
        const [cat,idxStr]=t.getAttribute('data-del').split(':');
        parosData[cat].splice(Number(idxStr),1);
        renderParoList(cat);
      }
    });
  }
  function validateParosVsAtraso(){
    const atrasoTxt = atraso_min_detalle.dataset.minutos || 'NaN';
    const atrasoMin = Number(atrasoTxt);
    const tot = Number(paros_total.textContent||0);
    if(!isFinite(atrasoMin) || atrasoMin<=0){
      paros_alerta.className='muted';
      paros_alerta.textContent='Se validará contra el atraso calculado.';
      return;
    }
    const diff=Math.abs(tot-atrasoMin);
    if(diff<=1){ paros_alerta.className='ok'; paros_alerta.textContent=`OK: paros coinciden con el atraso (${Math.round(atrasoMin)} min).`; }
    else if(diff<=5){ paros_alerta.className='warn'; paros_alerta.textContent=`Revisar: diferencia de ${diff} min vs atraso calculado (${Math.round(atrasoMin)} min).`; }
    else{ paros_alerta.className='err'; paros_alerta.textContent=`No coincide: paros ${tot} min, atraso ${Math.round(atrasoMin)} min.`; }
  }

  // -------- Cálculo principal (Turno ∩ Lote) --------
  function updateCalculos(){
    updateVelocidadProgramada();

    calc_err.classList.remove('show');
    calc_err.textContent = '';

    const bounds = getShiftBoundsLocal(fecha.value || '');
    const turnoNum = bounds?.turnoNum || '';
    const turnoLabel = bounds?.label || '';
    const inicio = parseDateTimeLocal(env_inicio.value);
    const fin = parseDateTimeLocal(env_fin.value);
    const velProg = Number(vel_prog.value || 0);
    const reales = Number(unid_reales.value || 0);

    // Reset salidas
    unid_teoricas.value = '';
    horas_atraso.value = '';
    atraso_min_detalle.textContent = '';
    delete atraso_min_detalle.dataset.minutos;
    detalle_descuentos.textContent = '';

    if(!bounds){ calc_err.textContent = 'Seleccione Fecha del turno y Turno.'; calc_err.classList.add('show'); validateParosVsAtraso(); updateProductividad(); return; }
    if(!inicio){ calc_err.textContent = 'Ingrese Inicio del lote (fecha y hora).'; calc_err.classList.add('show'); validateParosVsAtraso(); updateProductividad(); return; }
    if(!velProg){ calc_err.textContent = 'Seleccione el Producto para asignar la velocidad programada.'; calc_err.classList.add('show'); validateParosVsAtraso(); updateProductividad(); return; }

    // Intersección: ventana = [max(inicio_turno, inicio_lote), min(fin_turno, fin_lote || fin_turno)]
    let winStart = new Date(Math.max(bounds.start.getTime(), inicio.getTime()));
    let winEnd = bounds.end;
    if (fin) winEnd = new Date(Math.min(bounds.end.getTime(), fin.getTime()));

    // Diagnósticos de ventana vacía
    if (fin && fin <= bounds.start){
      unid_teoricas.value = 0;
      horas_atraso.value = (0).toFixed(2);
      atraso_min_detalle.dataset.minutos = 0;
      calc_err.textContent = 'El lote terminó antes de iniciar este turno. (Ventana vacía)';
      calc_err.classList.add('show');
      validateParosVsAtraso(); updateProductividad();
      return;
    }
    if (inicio >= bounds.end){
      unid_teoricas.value = 0;
      horas_atraso.value = (0).toFixed(2);
      atraso_min_detalle.dataset.minutos = 0;
      calc_err.textContent = 'El lote inicia después de terminar este turno. (Ventana vacía)';
      calc_err.classList.add('show');
      validateParosVsAtraso(); updateProductividad();
      return;
    }
    if(!(winStart < winEnd)){
      unid_teoricas.value = 0;
      horas_atraso.value = (0).toFixed(2);
      atraso_min_detalle.dataset.minutos = 0;
      calc_err.textContent = 'La ventana de cálculo quedó vacía. Verifique horarios.';
      calc_err.classList.add('show');
      validateParosVsAtraso(); updateProductividad();
      return;
    }

    // Descuentos
    const minutosBrutos = Math.max(0, minutesBetween(winStart, winEnd));
    const descCasino = casinoMinutes(bounds, winStart, winEnd, turnoNum);
    const base = Math.max(minutosBrutos - descCasino, 0);
    const { work: minutosTrabajo, breaks: descPausas, count: cantPausas } = computeWorkAndBreaks(base);
    const minutosEfectivos = Math.max(minutosTrabajo, 0);

    // Teóricas
    const teoricas = Math.floor(minutosEfectivos * velProg);
    unid_teoricas.value = isFinite(teoricas) ? teoricas : '';

    // Detalle
    const casinoTxt = descCasino ? ` · Casino ${descCasino} min` : '';
    const pausasTxt = cantPausas > 0 ? ` · Pausas ${cantPausas}×10 = ${descPausas} min` : ' · Pausas 0 min';
    detalle_descuentos.textContent = `Ventana: ${fmtDateTime(winStart)} → ${fmtDateTime(winEnd)} | Bruto: ${Math.round(minutosBrutos)} min${casinoTxt}${pausasTxt} → Efectivo: ${Math.round(minutosEfectivos)} min`;

    // Atraso (si hay reales)
    if(isFinite(reales) && velProg>0){
      const diffUnid = Math.max(teoricas - reales, 0);
      const atrasoMin = (diffUnid / velProg) * 60;
      horas_atraso.value = (atrasoMin/60).toFixed(2);
      atraso_min_detalle.textContent = `≈ ${Math.round(atrasoMin)} min de atraso`;
      atraso_min_detalle.dataset.minutos = Math.round(atrasoMin);
    }

    validateParosVsAtraso();
    updateProductividad();
  }

  // -------- Mensaje (incluye Productividad y formato de PAROS sin espacios en separadores) --------
  function buildMessage(){
    const bounds = getShiftBoundsLocal(fecha.value || '');
    const turnoNum = bounds?.turnoNum || '';
    const turnoLabel = bounds?.label || '';

    const f=fecha.value||''; 
    const aus=ausentismos.value||'N/A';
    const fl=fab_lote.value||'N/A'; 
    const fe=fab_estado.value||'N/A'; 
    const fp=(fab_pendientes.value||'N/A').trim();

    const prod=env_producto.value||'N/A'; 
    const elote=env_lote.value||'N/A';
    const iniDT=parseDateTimeLocal(env_inicio.value); 
    const finDT=parseDateTimeLocal(env_fin.value);
    const ini=iniDT?fmtDateTime(iniDT):'N/A'; 
    const fin=finDT?fmtDateTime(finDT):'N/A';
    const vp=vel_prog.value||'N/A'; 
    const vr=vel_real.value||'N/A';
    const ut=unid_teoricas.value||'N/A'; 
    const ur=unid_reales.value||'N/A';
    const prodTxt = productividad?.value ? productividad.value : 'N/D';
    const atrasoMinTxt = atraso_min_detalle.dataset.minutos ? `${atraso_min_detalle.dataset.minutos} min` : 'N/D';
    const estTxt = (estibas_text.value||'').trim() || 'N/A';

    const lines=[];
    lines.push('ENTREGA DE TURNO – ALCOHOL');
    lines.push(`Fecha: ${f} · Turno: ${turnoNum}`);
    lines.push(`Horario: ${turnoLabel}`);
    lines.push(`Ausentismos: ${aus}`);
    lines.push('');
    lines.push('FABRICACIÓN');
    lines.push(`- Lote: ${fl}`);
    lines.push(`- Estado: ${fe}`);
    lines.push(`- Pendientes: ${fp}`);
    lines.push('');
    lines.push('ENVASE');
    lines.push(`- Producto: ${prod}`);
    lines.push(`- Lote: ${elote}`);
    lines.push(`- Inicio: ${ini}`);
    lines.push(`- Fin: ${fin}`);
    lines.push(`- Velocidad programada: ${vp} frascos/min`);
    lines.push(`- Velocidad real (reportada): ${vr} frascos/min`);
    lines.push(`- Unidades teóricas: ${ut}`);
    lines.push(`- Unidades reales: ${ur}`);
    lines.push(`- Productividad: ${prodTxt}`);
    lines.push(`- Estibas: ${estTxt}`);
    lines.push(`- Atraso: ${horas_atraso.value||'0.00'} h (${atrasoMinTxt})`);
    lines.push('');
    lines.push('PAROS');
    // Encabezados de categoría SIN espacios alrededor del "·"
    const labels={equipo:'Equipo', proceso:'Proceso', alistamiento:'Alistamiento', ausentismo:'Ausentismo', esteril:'Novedad estéril', materiales:'Materiales'};
    for(const [cat,label] of Object.entries(labels)){
      const arr=parosData[cat]; 
      const sum=arr.reduce((a,b)=>a+(Number(b.min)||0),0);
      lines.push(`${label}·Total: ${sum} min`);
      if(arr.length===0){ lines.push('•—'); }
      else {
        // Ítems SIN espacios alrededor de la raya "–"
        arr.forEach(it=> lines.push(`• ${it.min} min–${it.just || 'Sin justificación'}`));
      }
    }
    lines.push(`Total paros: ${paros_total.textContent} min`);
    return lines.join('\n');
  }

  // -------- Utilidades varias --------
  function openWhatsApp(text){ const url=`https://wa.me/?text=${encodeURIComponent(text)}`; window.open(url,'_blank'); }
  function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>alert('Mensaje copiado al portapapeles.')).catch(()=>{
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('Mensaje copiado (método alternativo).');
    });
  }
  function clearForm(){
    ausentismos.value=''; fab_lote.value=''; fab_estado.value='N/A'; fab_pendientes.value='';
    env_producto.value=''; env_lote.value=''; env_inicio.value=''; env_fin.value='';
    vel_prog.value=''; vel_real.value=''; unid_teoricas.value=''; unid_reales.value=''; productividad.value='';
    estibas_text.value='';
    horas_atraso.value=''; atraso_min_detalle.textContent=''; detalle_descuentos.textContent=''; calc_err.classList.remove('show'); calc_err.textContent='';
    for(const k of Object.keys(parosData)){ parosData[k]=[]; renderParoList(k); }
    paros_total.textContent='0'; paros_alerta.className='muted'; paros_alerta.textContent='Se validará contra el atraso calculado.';
    mensaje.value=''; btn_whatsapp.disabled=true; btn_copiar.disabled=true;
    fecha.valueAsDate=new Date(); turnoSel.value='';
  }

  // -------- Eventos --------
  ;[fecha,turnoSel,env_inicio,env_fin,vel_real].forEach(el=>{
    el.addEventListener('input', updateCalculos);
    el.addEventListener('change', updateCalculos);
  });
  env_producto.addEventListener('change', ()=>{ updateVelocidadProgramada(); updateCalculos(); });
  env_producto.addEventListener('input',  ()=>{ updateVelocidadProgramada(); updateCalculos(); });
  unid_reales.addEventListener('input',  ()=>{ updateProductividad(); });
  unid_reales.addEventListener('change', ()=>{ updateProductividad(); });

  const btn_add_estiba = document.getElementById('btn_add_estiba'); // (si en el futuro revives chips)
  // Paros
  attachParoHandlers();
  ['equipo','proceso','alistamiento','ausentismo','esteril','materiales'].forEach(renderParoList);

  function validateBeforeGenerate(){
    if(!fecha.value){ alert('Seleccione la Fecha del turno.'); return false; }
    if(!turnoSel.value){ alert('Seleccione el Turno (variante).'); return false; }
    if(!env_producto.value){ alert('Seleccione el Producto.'); return false; }
    if(!env_inicio.value){ alert('Ingrese Inicio del lote (fecha y hora).'); return false; }
    if(!vel_prog.value){ alert('La velocidad programada no se ha asignado (verifique Producto).'); return false; }
    return true;
  }

  btn_generar.addEventListener('click', (e)=>{
    e.preventDefault();
    if(!validateBeforeGenerate()) return;
    updateCalculos();
    updateProductividad();
    const text = buildMessage();
    mensaje.value = text;
    btn_whatsapp.disabled=false; btn_copiar.disabled=false;
  });
  btn_whatsapp.addEventListener('click', e=>{ e.preventDefault(); if(!mensaje.value){ alert('Genere el mensaje primero.'); return; } openWhatsApp(mensaje.value); });
  btn_copiar.addEventListener('click', e=>{ e.preventDefault(); if(!mensaje.value){ alert('Genere el mensaje primero.'); return; } copyToClipboard(mensaje.value); });
  btn_limpiar.addEventListener('click', e=>{ e.preventDefault(); clearForm(); });

  // Inicial
  fab_estado.value = "N/A";
  updateVelocidadProgramada();
  updateCalculos();
  updateProductividad();
})();
</script>
</body>
</html>
``
