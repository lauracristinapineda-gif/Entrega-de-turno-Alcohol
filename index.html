<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0d6efd" />
<title>üß¥ Entrega de Turno ‚Äì Alcohol</title>
<style>
  :root { --c1:#0d6efd; --c2:#198754; --c3:#dc3545; --c4:#6b7280; --bg:#f4f6fb; --ink:#1f2937; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Color Emoji"; background: var(--bg); margin:0; color:var(--ink); }
  header { position: sticky; top:0; z-index:5; background:#fff; padding: .9rem 1rem calc(.6rem + env(safe-area-inset-top)); box-shadow: 0 4px 16px rgba(0,0,0,.06); }
  header h1{ margin:0; font-size:1.15rem; display:flex; gap:.5rem; align-items:center; }
  header .sub { color:#64748b; font-size:.88rem; margin-top:.25rem; }
  .wrap { padding:1rem; padding-bottom: calc(6.2rem + env(safe-area-inset-bottom)); max-width: 960px; margin: 0 auto; }
  fieldset { border:1px solid #e5e7eb; border-radius:12px; margin: .9rem 0; padding: .9rem; background:#fff; }
  legend { padding:0 .6rem; font-weight:700; color:#111827; }
  .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:.8rem .9rem; }
  .col-12{grid-column: span 12;} .col-8{grid-column: span 8;} .col-6{grid-column: span 6;} .col-4{grid-column:span 4;} .col-3{grid-column:span 3;}
  @media (max-width:760px){ .col-8,.col-6,.col-4,.col-3{grid-column:span 12;} }
  label { display:block; font-size:.96rem; margin-bottom:.25rem; }
  input, select, textarea { width:100%; padding:.82rem .95rem; border:1px solid #d1d5db; border-radius:12px; background:#fff; font-size:1rem; -webkit-tap-highlight-color: transparent; }
  input.readonly, textarea.readonly{ background:#f3f6fb; }
  textarea { min-height:88px; resize: vertical; }
  .hint { font-size:.84rem; color:#6b7280; }
  .muted { color:#6b7280; font-size:.92rem; }
  .kpi { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:.7rem .9rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;}
  .kpi .val { font-weight:800; }
  .ok { color: var(--c2); } .warn { color: #f59e0b; } .err { color: var(--c3); }
  .rowline { border-top:1px dashed #e5e7eb; margin:.7rem 0 0; padding-top:.7rem; }
  .actionbar { position: fixed; left:0; right:0; bottom:0; z-index:10; background:#fff; padding: .6rem .8rem calc(.8rem + env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,.08); display:flex; gap:.5rem; flex-wrap:wrap; }
  .actionbar button{ flex:1 1 48%; min-height:46px; border:none; border-radius:12px; color:#fff; font-weight:700; font-size:1rem; letter-spacing:.2px; }
  .primary{ background:var(--c1); } .success{ background:var(--c2);} .ghost{ background:#fff; color:#111; border:1px solid #d1d5db;} .secondary{ background:var(--c4); color:#fff;}
  .badge { display:inline-block; background:#eef2ff; color:#1e3a8a; padding:.1rem .5rem; border-radius:999px; font-size:.78rem; }
  /* Estibas (chips) */
  .chiplist { display:flex; gap:.4rem; flex-wrap: wrap; margin-top:.5rem; }
  .chip { background:#eef2ff; color:#1e3a8a; padding:.28rem .55rem; border-radius:999px; display:inline-flex; align-items:center; gap:.4rem; font-weight:700; }
  .chip button { border:none; background:transparent; color:#1e3a8a; cursor:pointer; font-weight:900; }
  /* Paros (listas verticales) */
  .paro-form { display:flex; gap:.5rem; flex-wrap:wrap; }
  .paro-form input[type="number"]{ max-width: 140px; }
  .paro-list { margin:.5rem 0 0; padding:0; list-style:none; }
  .paro-item { display:flex; align-items:flex-start; gap:.6rem; border:1px solid #e5e7eb; background:#f9fafb; border-radius:10px; padding:.5rem .6rem; margin-bottom:.5rem; }
  .paro-min { font-weight:800; color:#111827; min-width:60px; }
  .paro-just { color:#374151; white-space: pre-wrap; }
  .paro-actions button { border:none; background:transparent; color:#dc2626; cursor:pointer; font-weight:800; }
</style>
</head>
<body>
<header>
  <h1>üß¥ Entrega de Turno ‚Äì Alcohol</h1>
  <div class="sub">Calcula te√≥ricas seg√∫n tu regla, resta pausas/casino, valida paros y genera WhatsApp.</div>
</header>

<div class="wrap">
  <fieldset>
    <legend>üìÖ Datos generales</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" required />
      </div>
      <div class="col-6">
        <label for="turno">Turno</label>
        <select id="turno" required>
          <option value="">-- Seleccione --</option>
          <option value="1">Turno 1 (07:00‚Äì15:00)</option>
          <option value="2">Turno 2 (15:00‚Äì23:00)</option>
        </select>
      </div>
      <div class="col-12">
        <label for="ausentismos">üë• Ausentismos</label>
        <input type="text" id="ausentismos" placeholder="Nombres, horas, observaciones..." inputmode="text"/>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>üè≠ FABRICACI√ìN</legend>
    <div class="grid">
      <div class="col-6">
        <label for="fab_lote">Lote</label>
        <input type="text" id="fab_lote" placeholder="Ej: AL-240215-01" />
      </div>
      <div class="col-6">
        <label for="fab_estado">Estado</label>
        <select id="fab_estado">
          <option value="N/A">N/A</option>
          <option value="En proceso">En proceso</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Finalizado">Finalizado</option>
        </select>
      </div>
      <div class="col-12">
        <label for="fab_pendientes">üìù Pendientes</label>
        <textarea id="fab_pendientes" placeholder="Acciones abiertas, materiales, calidad, etc."></textarea>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>üì¶ ENVASE</legend>
    <div class="grid">
      <div class="col-12">
        <label for="env_producto">Producto</label>
        <select id="env_producto" required>
          <option value="">-- Seleccione --</option>
          <option>ALCOHOL 700ML</option>
          <option>ALCOHOL 350 ML</option>
          <option>ALCOHOL 120ML</option>
          <option>ALCOHOL GARRAFA 37000 ML</option>
          <option>MERTHIOLATE ROJO</option>
          <option>MERTHIOLATE INCOLORO</option>
          <option>ILOTICINA PLUS</option>
          <option>ILOTICINA DUO</option>
          <option>ILOTICINA PLUS MM</option>
          <option>ILOTICINA DUO MM</option>
        </select>
      </div>
      <div class="col-6">
        <label for="env_lote">Lote</label>
        <input type="text" id="env_lote" placeholder="Ej: ENV-240215-03" />
      </div>
      <div class="col-6">
        <!-- (Se quit√≥ el selector de c√°lculo, ahora es fijo seg√∫n regla) -->
        <div class="muted">C√°lculo fijo: <span class="badge">Inicio lote ‚Üí Fin turno</span> o <span class="badge">Inicio turno ‚Üí Fin lote</span> si inici√≥ d√≠a anterior.</div>
      </div>

      <div class="col-6">
        <label for="env_inicio">üïí Inicio del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_inicio" required />
      </div>
      <div class="col-6">
        <label for="env_fin">üïò Fin del lote (fecha y hora)</label>
        <input type="datetime-local" id="env_fin" />
        <div class="hint">Si el lote inici√≥ un d√≠a anterior, se usa este fin (si existe).</div>
      </div>

      <div class="col-6">
        <label for="vel_prog">üéØ Velocidad programada (frascos/min)</label>
        <input type="number" id="vel_prog" class="readonly" readonly />
        <div class="hint">Se autocompleta seg√∫n el producto.</div>
      </div>
      <div class="col-6">
        <label for="vel_real">‚öôÔ∏è Velocidad real (frascos/min)</label>
        <input type="number" id="vel_real" min="0" step="0.1" placeholder="Dato reportado por el supervisor" />
      </div>

      <div class="col-6">
        <label for="unid_teoricas">üìà Unidades te√≥ricas (auto)</label>
        <input type="number" id="unid_teoricas" class="readonly" readonly />
        <div class="muted" id="detalle_descuentos"></div>
      </div>
      <div class="col-6">
        <label for="unid_reales">üì¶ Unidades reales</label>
        <input type="number" id="unid_reales" min="0" />
      </div>

      <!-- ESTIBAS 000‚Äì999 -->
      <div class="col-12">
        <label>üß± Estibas (c√≥digos 000‚Äì999)</label>
        <div class="paro-form">
          <input id="estiba_code" type="text" inputmode="numeric" pattern="\\d{3}" maxlength="3" placeholder="Ej: 007" />
          <button id="btn_add_estiba" class="ghost" type="button">‚ûï Agregar</button>
          <div class="muted">Total: <span id="estibas_count">0</span></div>
        </div>
        <div class="chiplist" id="estibas_chiplist"></div>
      </div>

      <div class="col-12">
        <label for="horas_atraso">‚è±Ô∏è Horas de atraso (auto)</label>
        <input type="text" id="horas_atraso" class="readonly" readonly />
        <div class="muted" id="atraso_min_detalle"></div>
      </div>
    </div>

    <div class="rowline"></div>

    <!-- PAROS POR CATEGOR√çA: listas verticales con (min + justificaci√≥n) -->
    <div class="grid">
      <div class="col-12"><b>üõë Paros por‚Ä¶</b> (agrega los √≠tems por categor√≠a)</div>

      <!-- Equipo -->
      <div class="col-12">
        <label>‚öôÔ∏è Equipo <span class="muted">(min + justificaci√≥n)</span> ¬∑ <span class="badge">Total: <span id="sum_equipo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="equipo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="equipo_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="equipo">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_equipo"></ul>
      </div>

      <!-- Proceso -->
      <div class="col-12">
        <label>üîÅ Proceso ¬∑ <span class="badge">Total: <span id="sum_proceso">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="proceso_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="proceso_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="proceso">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_proceso"></ul>
      </div>

      <!-- Alistamiento -->
      <div class="col-12">
        <label>üß∞ Alistamiento ¬∑ <span class="badge">Total: <span id="sum_alistamiento">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="alistamiento_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="alistamiento_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="alistamiento">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_alistamiento"></ul>
      </div>

      <!-- Ausentismo -->
      <div class="col-12">
        <label>üë• Ausentismo ¬∑ <span class="badge">Total: <span id="sum_ausentismo">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="ausentismo_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="ausentismo_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="ausentismo">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_ausentismo"></ul>
      </div>

      <!-- Novedad est√©ril -->
      <div class="col-12">
        <label>üß™ Novedad est√©ril ¬∑ <span class="badge">Total: <span id="sum_esteril">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="esteril_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="esteril_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="esteril">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_esteril"></ul>
      </div>

      <!-- Materiales -->
      <div class="col-12">
        <label>üì¶ Materiales ¬∑ <span class="badge">Total: <span id="sum_materiales">0</span> min</span></label>
        <div class="paro-form">
          <input type="number" id="materiales_min" min="0" step="1" placeholder="Minutos" />
          <input type="text" id="materiales_just" placeholder="Justificaci√≥n..." />
          <button class="ghost" type="button" data-add="materiales">‚ûï Agregar</button>
        </div>
        <ul class="paro-list" id="list_materiales"></ul>
      </div>

      <div class="col-12 kpi">
        <div><b>Total paros</b> (min): <span class="val" id="paros_total">0</span></div>
        <div id="paros_alerta" class="muted">Se validar√° contra el atraso calculado.</div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>üì§ Mensaje</legend>
    <div class="grid">
      <div class="col-12">
        <label for="mensaje">Texto generado (WhatsApp)</label>
        <textarea id="mensaje" class="readonly" readonly placeholder="Toca Generar para ver el mensaje‚Ä¶"></textarea>
      </div>
    </div>
  </fieldset>
</div>

<div class="actionbar">
  <button class="primary" id="btn_generar">‚ú® Generar</button>
  <button class="success" id="btn_whatsapp" disabled>üì≤ WhatsApp</button>
  <button class="ghost" id="btn_copiar" disabled>üìã Copiar</button>
  <button class="secondary" id="btn_limpiar">üßπ Limpiar</button>
</div>

<script>
(function(){
  // Velocidades programadas
  const speedMap = {
    "ALCOHOL 700ML": 54,
    "ALCOHOL 350 ML": 64,
    "ALCOHOL 120ML": 67,
    "ALCOHOL GARRAFA 37000 ML": 6,
    "MERTHIOLATE ROJO": 12,
    "MERTHIOLATE INCOLORO": 12,
    "ILOTICINA PLUS": 10,
    "ILOTICINA DUO": 10,
    "ILOTICINA PLUS MM": 10,
    "ILOTICINA DUO MM": 10
  };

  // DOM refs
  const fecha = document.getElementById('fecha');
  const turno = document.getElementById('turno');
  const ausentismos = document.getElementById('ausentismos');

  const fab_lote = document.getElementById('fab_lote');
  const fab_estado = document.getElementById('fab_estado');
  const fab_pendientes = document.getElementById('fab_pendientes');

  const env_producto = document.getElementById('env_producto');
  const env_lote = document.getElementById('env_lote');
  const env_inicio = document.getElementById('env_inicio');
  const env_fin = document.getElementById('env_fin');
  const vel_prog = document.getElementById('vel_prog');
  const vel_real = document.getElementById('vel_real');
  const unid_teoricas = document.getElementById('unid_teoricas');
  const unid_reales = document.getElementById('unid_reales');

  // Estibas
  const estiba_code = document.getElementById('estiba_code');
  const btn_add_estiba = document.getElementById('btn_add_estiba');
  const estibas_chiplist = document.getElementById('estibas_chiplist');
  const estibas_count = document.getElementById('estibas_count');

  // Atraso
  const horas_atraso = document.getElementById('horas_atraso');
  const atraso_min_detalle = document.getElementById('atraso_min_detalle');
  const detalle_descuentos = document.getElementById('detalle_descuentos');

  // Paros
  const paros_alerta = document.getElementById('paros_alerta');
  const paros_total = document.getElementById('paros_total');

  // Totales por categor√≠a
  const sums = {
    equipo: document.getElementById('sum_equipo'),
    proceso: document.getElementById('sum_proceso'),
    alistamiento: document.getElementById('sum_alistamiento'),
    ausentismo: document.getElementById('sum_ausentismo'),
    esteril: document.getElementById('sum_esteril'),
    materiales: document.getElementById('sum_materiales'),
  };

  // Inputs de adici√≥n por categor√≠a
  const addInputs = {
    equipo: { min: document.getElementById('equipo_min'), just: document.getElementById('equipo_just'), list: document.getElementById('list_equipo') },
    proceso:{ min: document.getElementById('proceso_min'), just: document.getElementById('proceso_just'), list: document.getElementById('list_proceso') },
    alistamiento:{ min: document.getElementById('alistamiento_min'), just: document.getElementById('alistamiento_just'), list: document.getElementById('list_alistamiento') },
    ausentismo:{ min: document.getElementById('ausentismo_min'), just: document.getElementById('ausentismo_just'), list: document.getElementById('list_ausentismo') },
    esteril:{ min: document.getElementById('esteril_min'), just: document.getElementById('esteril_just'), list: document.getElementById('list_esteril') },
    materiales:{ min: document.getElementById('materiales_min'), just: document.getElementById('materiales_just'), list: document.getElementById('list_materiales') },
  };

  const btn_generar = document.getElementById('btn_generar');
  const btn_whatsapp = document.getElementById('btn_whatsapp');
  const btn_copiar = document.getElementById('btn_copiar');
  const btn_limpiar = document.getElementById('btn_limpiar');
  const mensaje = document.getElementById('mensaje');

  // Estado
  let estibasArr = []; // ["007","145",...]
  const parosData = { equipo:[], proceso:[], alistamiento:[], ausentismo:[], esteril:[], materiales:[] };
  // cada item: {min: number, just: string}

  // Utils
  fecha.valueAsDate = new Date();
  fab_estado.value = "N/A";

  function parseDTLocal(v){ if(!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d; }
  function two(n){ return String(n).padStart(2,'0'); }
  function fmtDateTime(d){ if(!d) return ""; return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`; }
  function ymd(d){ return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`; }
  function stripNonDigits(s){ return (s||'').replace(/\\D+/g,''); }
  function minutesBetween(a,b){ return (b - a) / 60000; }
  function getShiftBounds(dateOnly, turnoVal){
    if(!dateOnly || !turnoVal) return null;
    const base = new Date(dateOnly);
    const start = new Date(base), end = new Date(base);
    if(turnoVal==='1'){ start.setHours(7,0,0,0); end.setHours(15,0,0,0); }
    else if(turnoVal==='2'){ start.setHours(15,0,0,0); end.setHours(23,0,0,0); }
    else return null;
    return {start, end};
  }

  function updateVelocidadProgramada(){
    const prod = env_producto.value;
    vel_prog.value = prod && speedMap[prod] ? speedMap[prod] : "";
  }

  // Casino: 12:00 (T1) y 19:00 (T2) si la ventana lo cruza (40 min)
  function casinoMinutes(bounds, winStart, winEnd, turnoVal){
    let m = 0;
    if(turnoVal === '1'){
      const t1200 = new Date(bounds.start); t1200.setHours(12,0,0,0);
      if(winStart < t1200 && winEnd > t1200) m += 40;
    } else if (turnoVal === '2'){
      const t1900 = new Date(bounds.start); t1900.setHours(19,0,0,0);
      if(winStart < t1900 && winEnd > t1900) m += 40;
    }
    return m;
  }

  // Pausas activas: 10 min cada 120 min de trabajo efectivo desde inicio del lote (iterativo)
  function computeWorkAndBreaks(minutesBase){
    let work = Math.max(minutesBase, 0);
    let prevCount = -1, count = 0, it = 0;
    while (it < 10){
      count = Math.floor(work / 120);
      if(count === prevCount) break;
      prevCount = count;
      work = Math.max(minutesBase - count*10, 0);
      it++;
    }
    return { work, breaks: count*10, count };
  }

  function updateParosTotals(){
    const catSum = (arr)=>arr.reduce((a,b)=>a + (Number(b.min)||0), 0);
    let total = 0;
    for(const k of Object.keys(parosData)){
      const s = catSum(parosData[k]);
      sums[k].textContent = s;
      total += s;
    }
    paros_total.textContent = total;
    validateParosVsAtraso();
  }

  function renderParoList(cat){
    const { list } = addInputs[cat];
    list.innerHTML = "";
    parosData[cat].forEach((item, idx)=>{
      const li = document.createElement('li');
      li.className = 'paro-item';
      li.innerHTML = `
        <div class="paro-min">${item.min} min</div>
        <div class="paro-just">${item.just ? item.just : '<span class="muted">Sin justificaci√≥n</span>'}</div>
        <div class="paro-actions" style="margin-left:auto;">
          <button title="Quitar" data-del="${cat}:${idx}">‚úñ</button>
        </div>
      `;
      list.appendChild(li);
    });
    updateParosTotals();
  }

  function attachParoHandlers(){
    document.querySelectorAll('button[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const cat = btn.getAttribute('data-add');
        const refs = addInputs[cat];
        const min = Number(refs.min.value);
        const just = String(refs.just.value||'').trim();
        if(!isFinite(min) || min<=0){
          alert('Ingresa minutos (>0) para agregar el paro.');
          return;
        }
        parosData[cat].push({min: Math.round(min), just});
        refs.min.value = '';
        refs.just.value = '';
        renderParoList(cat);
      });
    });
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.matches('button[data-del]')){
        const [cat, idxStr] = t.getAttribute('data-del').split(':');
        const idx = Number(idxStr);
        parosData[cat].splice(idx,1);
        renderParoList(cat);
      }
    });
  }

  function validateParosVsAtraso(){
    const atrasoTxt = atraso_min_detalle.dataset.minutos || "NaN";
    const atrasoMin = Number(atrasoTxt);
    const tot = Number(paros_total.textContent || 0);
    if(!isFinite(atrasoMin) || atrasoMin<=0){
      paros_alerta.className = "muted";
      paros_alerta.textContent = "Se validar√° contra el atraso calculado.";
      return;
    }
    const diff = Math.abs(tot - atrasoMin);
    if(diff <= 1){
      paros_alerta.className = "ok";
      paros_alerta.textContent = `‚úÖ OK: paros coinciden con el atraso (${Math.round(atrasoMin)} min).`;
    } else if (diff <= 5){
      paros_alerta.className = "warn";
      paros_alerta.textContent = `‚ö†Ô∏è Revisa: diferencia de ${diff} min vs atraso calculado (${Math.round(atrasoMin)} min).`;
    } else {
      paros_alerta.className = "err";
      paros_alerta.textContent = `‚ùå No coincide: paros ${tot} min, atraso ${Math.round(atrasoMin)} min.`;
    }
  }

  function sameDay(d1, d2){ return d1 && d2 && d1.toDateString() === d2.toDateString(); }

  function updateCalculos(){
    updateVelocidadProgramada();

    const turnoVal = turno.value;
    const fechaVal = fecha.value ? new Date(fecha.value) : null;
    const bounds = getShiftBounds(fechaVal, turnoVal);

    const inicio = parseDTLocal(env_inicio.value);
    const fin = parseDTLocal(env_fin.value);
    const velProg = Number(vel_prog.value || 0);
    const reales = Number(unid_reales.value || 0);

    // Reset vistas
    unid_teoricas.value = "";
    horas_atraso.value = "";
    atraso_min_detalle.textContent = "";
    delete atraso_min_detalle.dataset.minutos;
    detalle_descuentos.textContent = "";

    if(!bounds || !inicio || !velProg){
      validateParosVsAtraso();
      return;
    }

    // Regla de c√°lculo:
    // - Normal: Inicio del lote ‚Üí Fin del turno
    // - Si inici√≥ un d√≠a anterior: Inicio del turno ‚Üí Fin del lote (si hay fin; si no, hasta fin del turno)
    let winStart, winEnd;
    const startedPrevDay = inicio < bounds.start && !sameDay(inicio, bounds.start);
    if (startedPrevDay){
      winStart = bounds.start;
      winEnd = fin ? new Date(Math.min(fin.getTime(), bounds.end.getTime())) : bounds.end;
    } else {
      winStart = new Date(Math.max(inicio.getTime(), bounds.start.getTime()));
      winEnd = bounds.end; // ignorar fin de lote en el caso normal (como pediste)
    }

    if(winStart >= winEnd){
      unid_teoricas.value = 0;
      horas_atraso.value = (0).toFixed(2);
      atraso_min_detalle.dataset.minutos = 0;
      validateParosVsAtraso();
      return;
    }

    // Minutos brutos dentro de la ventana
    const minutosBrutos = Math.max(0, minutesBetween(winStart, winEnd));
    // Casino seg√∫n turno (40 min si cruza 12:00 en T1 o 19:00 en T2)
    const descCasino = casinoMinutes(bounds, winStart, winEnd, turnoVal);
    // Base para pausas
    const minutosBase = Math.max(minutosBrutos - descCasino, 0);
    // Pausas activas (10 min cada 120 min de trabajo efectivo)
    const { work: minutosTrabajo, breaks: descPausas, count: cantPausas } = computeWorkAndBreaks(minutosBase);
    const minutosEfectivos = Math.max(minutosTrabajo, 0);

    const teoricas = Math.floor(minutosEfectivos * velProg);
    unid_teoricas.value = isFinite(teoricas) ? teoricas : "";

    // Detalle
    const casinoTxt = descCasino ? ` ¬∑ üçΩÔ∏è Casino ${descCasino} min` : '';
    const pausasTxt = cantPausas > 0 ? ` ¬∑ üßò Pausas ${cantPausas}√ó10 = ${descPausas} min` : ' ¬∑ üßò Pausas 0 min';
    detalle_descuentos.textContent = `Ventana: ${fmtDateTime(winStart)} ‚Üí ${fmtDateTime(winEnd)} | Bruto: ${Math.round(minutosBrutos)} min${casinoTxt}${pausasTxt} ‚Üí Efectivo: ${Math.round(minutosEfectivos)} min`;

    // Horas de atraso
    if(isFinite(reales) && velProg>0){
      const diffUnid = Math.max(teoricas - reales, 0);
      const atrasoMin = (diffUnid / velProg) * 60;
      horas_atraso.value = (atrasoMin/60).toFixed(2);
      atraso_min_detalle.textContent = `‚âà ${Math.round(atrasoMin)} min de atraso`;
      atraso_min_detalle.dataset.minutos = Math.round(atrasoMin);
    }

    validateParosVsAtraso();
  }

  // -------- Estibas (chips 000‚Äì999) ----------
  function addEstiba(){
    let code = stripNonDigits(estiba_code.value);
    if(code.length === 0){ alert('Ingresa un c√≥digo de estiba de 3 d√≠gitos (000‚Äì999).'); return; }
    if(code.length < 3) code = code.padStart(3, '0');
    if(!/^\\d{3}$/.test(code)){ alert('Formato inv√°lido. Usa 3 d√≠gitos, ej: 007.'); return; }
    if(estibasArr.includes(code)){ alert('Ese c√≥digo ya fue agregado.'); return; }
    estibasArr.push(code);
    estiba_code.value = '';
    renderEstibas();
  }
  function renderEstibas(){
    estibas_chiplist.innerHTML = '';
    estibasArr.forEach((c, idx)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `${c} <button title="Quitar" data-estiba="${idx}">√ó</button>`;
      estibas_chiplist.appendChild(chip);
    });
    estibas_count.textContent = estibasArr.length;
  }
  btn_add_estiba.addEventListener('click', addEstiba);
  estiba_code.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addEstiba(); }});
  estibas_chiplist.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('button[data-estiba]')){
      const idx = Number(t.getAttribute('data-estiba'));
      estibasArr.splice(idx,1);
      renderEstibas();
    }
  });

  // -------- Eventos y c√°lculos ----------
  function updateVelocidadProgramada(){ vel_prog.value = env_producto.value && speedMap[env_producto.value] ? speedMap[env_producto.value] : ""; }

  [fecha, turno, env_producto, env_inicio, env_fin, vel_real, unid_reales].forEach(el=>{
    el.addEventListener('input', updateCalculos);
    el.addEventListener('change', updateCalculos);
  });

  function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=> alert('Mensaje copiado al portapapeles.'))
    .catch(()=>{
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('Mensaje copiado (m√©todo alternativo).');
    });
  }
  function openWhatsApp(text){ const url = `https://wa.me/?text=${encodeURIComponent(text)}`; window.open(url, '_blank'); }

  function clearForm(){
    ausentismos.value = ""; fab_lote.value = ""; fab_estado.value = "N/A"; fab_pendientes.value = "";
    env_producto.value = ""; env_lote.value = ""; env_inicio.value = ""; env_fin.value = "";
    vel_prog.value = ""; vel_real.value = ""; unid_teoricas.value = ""; unid_reales.value = "";
    horas_atraso.value = ""; atraso_min_detalle.textContent = ""; detalle_descuentos.textContent = "";
    estibasArr = []; renderEstibas();

    for(const k of Object.keys(parosData)){ parosData[k] = []; renderParoList(k); }
    paros_total.textContent = "0"; paros_alerta.className = "muted"; paros_alerta.textContent = "Se validar√° contra el atraso calculado.";
    mensaje.value = ""; btn_whatsapp.disabled = true; btn_copiar.disabled = true;
    fecha.valueAsDate = new Date(); turno.value = "";
  }

  // Construir mensaje
  function buildMessage(){
    const f = fecha.value || ''; const t = turno.value || ''; const aus = ausentismos.value || 'N/A';
    const fl = fab_lote.value || 'N/A'; const fe = fab_estado.value || 'N/A'; const fp = (fab_pendientes.value || 'N/A').trim();
    const prod = env_producto.value || 'N/A'; const elote = env_lote.value || 'N/A';
    const ini = parseDTLocal(env_inicio.value) ? fmtDateTime(parseDTLocal(env_inicio.value)) : 'N/A';
    const fin = parseDTLocal(env_fin.value) ? fmtDateTime(parseDTLocal(env_fin.value)) : 'N/A';
    const vp = vel_prog.value || 'N/A'; const vr = vel_real.value || 'N/A';
    const ut = unid_teoricas.value || 'N/A'; const ur = unid_reales.value || 'N/A';
    const atrasoMinTxt = atraso_min_detalle.dataset.minutos ? `${atraso_min_detalle.dataset.minutos} min` : 'N/D';
    const estList = estibasArr.length ? estibasArr.join(', ') : 'N/A';

    const lines = [];
    lines.push(`üß¥ ENTREGA DE TURNO ‚Äì ALCOHOL`);
    lines.push(`üìÖ Fecha: ${f} ¬∑ üïí Turno: ${t}`);
    lines.push(`üë• Ausentismos: ${aus}`);
    lines.push(``);
    lines.push(`üè≠ FABRICACI√ìN`);
    lines.push(`- Lote: ${fl}`);
    lines.push(`- Estado: ${fe}`);
    lines.push(`- Pendientes: ${fp}`);
    lines.push(``);
    lines.push(`üì¶ ENVASE`);
    lines.push(`- Producto: ${prod}`);
    lines.push(`- Lote: ${elote}`);
    lines.push(`- Inicio: ${ini}`);
    lines.push(`- Fin: ${fin}`);
    lines.push(`- üéØ Vel. programada: ${vp} frascos/min`);
    lines.push(`- ‚öôÔ∏è Vel. real (reportada): ${vr} frascos/min`);
    lines.push(`- üìà Unidades te√≥ricas: ${ut}`);
    lines.push(`- üì¶ Unidades reales: ${ur}`);
    lines.push(`- üß± Estibas (000‚Äì999): ${estList}`);
    lines.push(`- ‚è±Ô∏è Atraso: ${horas_atraso.value || '0.00'} h (${atrasoMinTxt})`);
    lines.push(``);
    lines.push(`üõë Paros`);
    for(const [cat,label] of Object.entries({
      equipo:'‚öôÔ∏è Equipo', proceso:'üîÅ Proceso', alistamiento:'üß∞ Alistamiento', ausentismo:'üë• Ausentismo', esteril:'üß™ Novedad est√©ril', materiales:'üì¶ Materiales'
    })){
      const arr = parosData[cat];
      const sum = arr.reduce((a,b)=>a+(Number(b.min)||0),0);
      lines.push(`${label} ¬∑ Total: ${sum} min`);
      if(arr.length===0){ lines.push(`‚Ä¢ ‚Äî`); }
      else arr.forEach(it=> lines.push(`‚Ä¢ ${it.min} min ‚Äì ${it.just || 'Sin justificaci√≥n'}`));
    }
    lines.push(`Total paros: ${paros_total.textContent} min`);
    return lines.join('\n');
  }

  // Botones
  btn_generar.addEventListener('click', (e)=>{
    e.preventDefault();
    if(!fecha.value || !turno.value || !env_producto.value || !env_inicio.value){
      alert('Completa: Fecha, Turno, Producto e Inicio del lote.');
      return;
    }
    updateCalculos();
    const text = buildMessage();
    mensaje.value = text;
    btn_whatsapp.disabled = false; btn_copiar.disabled = false;
  });
  btn_whatsapp.addEventListener('click', (e)=>{ e.preventDefault(); if(!mensaje.value){ alert('Genera el mensaje primero.'); return; } openWhatsApp(mensaje.value); });
  btn_copiar.addEventListener('click', (e)=>{ e.preventDefault(); if(!mensaje.value){ alert('Genera el mensaje primero.'); return; } copyToClipboard(mensaje.value); });
  btn_limpiar.addEventListener('click', (e)=>{ e.preventDefault(); clearForm(); });

  // Inicializaciones
  updateCalculos();
  attachParoHandlers();
  ['equipo','proceso','alistamiento','ausentismo','esteril','materiales'].forEach(renderParoList);
})();
</script>
</body>
</html>
